<% if check_current_user_notify(spree_current_user) %>
  <div class="notification-box add-to-cart-form-general-availability" id="stock-notify-form">
    <div class="text-center mb-2 mt-3 add-to-cart-form-general-availability">Sold Out!</div>
    <span> <%= Spree.t(:click_notify_me) %> </span>
    <%= form_with(model: @stock_notify, url: stock_notify_api_v2_storefront_product_path(product_slug: @product.slug), method: :put, id: 'notify-me-form') do |form| %>
      <%= form.fields_for :stock_notify do |stock_notify_form| %>
        <% unless spree_current_user.present? %>
          <%= stock_notify_form.text_field :email, placeholder: 'Enter your email address', class: 'p-2 placeholder-glow', required: true %>
        <% else %>
          <%= stock_notify_form.hidden_field :email, value: spree_current_user.email %>
          <%= stock_notify_form.hidden_field :user_id, value: spree_current_user.id %>
        <% end %>
        <%= stock_notify_form.hidden_field :variant_id, value: @product.master.id, id:'stock_notify_variant_id'%>
      <% end %>
      <%= form.submit Spree.t(:notify_me_button), class: 'btn btn-secondary', id: 'notify-me-button' %>
    <% end %>
  </div>
<% end %>


<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('notify-me-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this); // Serialize form data
        var variantId = document.getElementById('stock_notify_variant_id').value;
        
        $.ajax({
            dataType: 'json',
            url: `/api/v2/storefront/products/${variantId}/stock_notify`,
            method: 'PUT',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
              console.log(response);
              var fetchDiv = document.getElementById('stock-notify-form')
              fetchDiv.innerHTML = '<div class="text-danger mb-2 mt-3 text-bold">Thank you for your interest! We will notify you as soon as the product becomes available.</div>';
            },
            error: function(xhr, status, error) {
                console.error(xhr.responseText);
                alert('Failed to create stock notification');
            }
        });
    });
});
</script>

